<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <title>Events List</title>

    <script
      async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCLXvXIF-axqigiDEH_KQQIpHgMrWY9F2U&callback=initMap&libraries=&v=weekly"
      type="text/javascript"
    ></script>
    <style type="text/css">
      /* Set the size of the div element that contains the map */
      #map {
      height: 200px;
      margin-top: auto;
      /* position:absolute; 
      right:-200px;  */
      margin-bottom: auto;
      width: 100%;    }
    </style>
    
</head>
{% extends 'base.html' %}
{% load socialaccount %}

<body>
{% block content %}
{% if user.is_authenticated %}
    <h3 class = 'text-center'>All Current Events</h3>
    <div class = 'text-center'>
      <a class = "btn btn-dark" href="{% url 'events:post_event' %}" role = "button">Post New Event</a><br><br>
    </div>
    <body>
      {% if events_list %}
      <div class="container">
          <ul class="list-group list-group-flush">
          {% for event in events_list%}
            <a href="{% url 'events:detail' event.id %}" class = 'list-group-item list-group-item-action'><b>{{event.title_text}}</b></b><br> {{event.description_text}}<br>{{event.address}}<br>{{event.geolocation}}</a></li>
          {%endfor%}
          </ul>
            
          <script type="text/javascript">  
            var map;
            // var event_list="{{events_list}}";
            // var eventlist_geolocation=[];
            var event_count= "{{events_list.count}}";
            // {% for event in events_list.all %}
            //   eventlist_geolocation.push("{{event.geolocation.lat}}");
            // {% endfor %}

            
            function initMap() {
              const charlottesville = { lat: 38.034837, lng: -78.5064309};
              map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: charlottesville,
              });
              
              google.maps.event.addListenerOnce(map, 'tilesloaded', addMarkers);
            }
            function addMarkers(){
                 const iconBase =
                   "http://maps.google.com/mapfiles/kml/shapes/";
                 const icons = {
                    parking: {
                      icon: iconBase + "parking_lot.png",
                    },
                    food: {
                      icon: iconBase + "convenience.png",
                    },
                  }
                 {% for event in events_list.all %}
                 var point = new google.maps.LatLng("{{event.geolocation.lat}}","{{event.geolocation.lon}}");
                 var marker=new google.maps.Marker({
                  position: point,
                  map: map,
                  icon: icons["food"].icon,
                  animation: google.maps.Animation.DROP,
                  title:'{{event.title_text}}',
                });
                marker['infowindow']  = new google.maps.InfoWindow({
                     content: "<h1>{{event.title_text}}</h1> <br> {{ event.location_text }} <br> {{event.category_text}} ",
                });
                marker.addListener("click",toggleBounce);
                google.maps.event.addListener(marker, 'click', function() {
                //window.location.href = this.url;
                 this['infowindow'].open(map, this);
                });
                google.maps.event.addListener(marker, 'mouseover', function() {
                    this['infowindow'].open(map, this);
                });
                google.maps.event.addListener(marker, 'mouseout', function() {
                    this['infowindow'].close(map, this);
                });

                marker.setMap(map);
               {% endfor %}
            }
            function toggleBounce() {
              if (marker.getAnimation() !== null) {
                marker.setAnimation(null);
              } 
              else {
                marker.setAnimation(google.maps.Animation.BOUNCE);
              }
            }
            google.maps.event.addDomListener(window, 'load', initialize);
            
              // var event_length=events_list.length();
              // var marker = new Array(event_length);
              // var lat = new Array(event_length);
              // var lng = new Array(event_length);
              // var latLng =new Array(event_length)
              // var i;
              // for (i = 0; i < events_list.length();i++) {
              //   var nameArr = events_list[i].geolocation.split(',');
              //   console.log(nameArr);
              //   lat[i]=events_list[i].geolocation.latitude
              //   long[i]=events_list[i].geolocation.longitude
              // }
              
              // for (i = 0; i < event_length;i++) {
              //    latLng[i]=new google.maps.LatLng(lat[i].latitude,
              //    long[i].longitude);
              //    marker[i] = new google.maps.Marker({
              //     position: latlng,
              //     map: map,
              //   });
              // }
          </script>
          <div id="map">
            <!-- <p>{{events_list}}</p> -->
          </div>
        </div>
      {% else %}
          <p>No events have been posted.</p>
      {% endif %}
    </body>
{% else %}
    <style>
    .container { height: 100%; width: 100%; justify-content: center !important; }
    .card{
      height: 370px;
      margin-top: auto;
      margin-bottom: auto;
      width: 400px;
      background-color: rgba(238, 238, 238, 0.5) !important;
  }</style>
    <div class="container">
      <div class="card">
        <div class="card-header">
          <h3 class="text-center login-title">Sign In</h3>
        </div>
        <div class="card-body">
          <p>Click "Login" to sign in with your Hoos2Meet Credentials.</p><br>
          <a class = "btn btn-dark" href="/accounts/login" role = "button">Login</a><br>
        </div>
        <div class="card-footer">
          <div class = "d-flex justify-content-center links">
            <p>Don't have an account? <br></p> <a href="{% provider_login_url 'google' %}"> SignUp with Google</a>
          </div>
        </div>
      </div>
    </div>
    
    
{% endif %}
{% endblock content %}

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

</body>
</html>